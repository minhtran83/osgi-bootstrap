task itest(type: Test) { 
  description = 'Run integration tests using PaxExam'
  def bundles = []
  def fragments = []

  project.configurations.itestBundles.each { bundles.add(it.path) }
  project.configurations.itestFragments.each { fragments.add(it.path) }
  
  // Write the list of bundles and fragments to a system property for use by the
  // integration tests
  systemProperty 'java.protocol.handler.pkgs', 'org.ops4j.pax.url'
  systemProperty 'iehr.osgi.integrationTest.bundles', bundles.join('::')
  systemProperty 'iehr.osgi.integrationTest.fragments', fragments.join('::')
  systemProperty 'iehr.osgi.integrationTest.configDir', "${projectDir}/src/itest/config" 

  testClassesDir = project.sourceSets.itest.output.classesDir
  classpath = project.sourceSets.itest.runtimeClasspath 
}

task copyResources(type:Copy) {
   from 'src/itest/resources'
   into 'build/classes/itest'
}

itest.dependsOn(cleanItest)
compileItestJava.dependsOn(copyResources)
